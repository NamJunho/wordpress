// ==========================
// Medium-Style Frontend Post (ê°„ì†Œí™” + placeholder ë³´ì™„: ì œëª©/ë³¸ë¬¸)
// ==========================

function sfp_enqueue_styles_and_scripts() {
    if (is_page() && has_shortcode(get_post()->post_content ?? '', 'sfp_frontend_post_form')) {
        wp_enqueue_style('sfp-styles', get_template_directory_uri() . '/style.css');
        wp_enqueue_script('jquery');
        // ëª¨ë‹¬ ì‚¬ìš©ì„ ìœ„í•´ Bootstrap ìœ ì§€(ì›ì¹˜ ì•Šìœ¼ë©´ ëª¨ë‹¬/ë§í¬ UIë¥¼ ì»¤ìŠ¤í…€í•˜ì„¸ìš”)
        wp_enqueue_style('bootstrap-css', 'https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css', [], null);
        wp_enqueue_script('popper-js', 'https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js', ['jquery'], null, true);
        wp_enqueue_script('bootstrap-js', 'https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js', ['jquery','popper-js'], null, true);
    }
}
add_action('wp_enqueue_scripts', 'sfp_enqueue_styles_and_scripts');

function sfp_frontend_post_form() {
    if (!is_user_logged_in()) {
        return '<div class="sfp-login-message">ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ê¸€ì„ ì œì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>';
    }

    // ìˆ˜ì • ëª¨ë“œ
    $is_edit = false;
    $edit_post = null;
    $edit_id = isset($_GET['edit']) ? absint($_GET['edit']) : 0;
    if ($edit_id) {
        $candidate = get_post($edit_id);
        if ($candidate && current_user_can('edit_post', $candidate->ID)) {
            $is_edit = true;
            $edit_post = $candidate;
        } else {
            return '<div class="alert alert-danger">í•´ë‹¹ ê¸€ì„ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        }
    }

    // ì´ˆê¸°ê°’
    $initial_title   = $is_edit ? $edit_post->post_title : '';
    $initial_content = $is_edit ? $edit_post->post_content : '';
    $selected_cat_id = 0;
    if ($is_edit) {
        $cats = wp_get_post_categories($edit_post->ID);
        if (!empty($cats)) $selected_cat_id = (int)$cats[0];
    }

    ob_start();
    ?>
    <div class="sfp-medium-shell">
        <form id="frontend-post-form" class="sfp-form" method="post" enctype="multipart/form-data" autocomplete="off">
            <?php wp_nonce_field('sfp_frontend_post_nonce', 'sfp_nonce'); ?>
            <?php if ($is_edit): ?>
                <input type="hidden" name="edit_post_id" value="<?php echo esc_attr($edit_post->ID); ?>">
            <?php endif; ?>

            <!-- ìƒë‹¨ ë°” -->
            <div class="sfp-topbar">
                <div class="sfp-topbar-left">
                    <select name="post_category" id="post_category" class="sfp-topbar-select" required>
                        <option value="" disabled <?php echo $is_edit ? '' : 'selected'; ?>>ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        <?php
                        $categories = get_categories(['hide_empty' => false]);
                        foreach ($categories as $category) {
                            $sel = ($is_edit && (int)$category->term_id === $selected_cat_id) ? ' selected' : '';
                            echo '<option value="' . esc_attr($category->term_id) . '"' . $sel . '>' . esc_html($category->name) . '</option>';
                        }
                        ?>
                    </select>
                </div>
                <div class="sfp-topbar-right">
                    <input type="submit" name="submit_post" value="<?php echo $is_edit ? 'ì—…ë°ì´íŠ¸' : 'ë°œí–‰'; ?>" class="sfp-btn primary">
                </div>
            </div>

            <!-- ë³¸ë¬¸ ì˜ì—­ -->
            <div class="sfp-editor-container" aria-label="ë¯¸ë””ì—„ ìŠ¤íƒ€ì¼ ì—ë””í„°">
                <!-- ì œëª© -->
                <div class="sfp-title" id="sfp-title" contenteditable="true" role="textbox" aria-multiline="true" data-placeholder="ì œëª©"></div>

                <!-- ë³¸ë¬¸ -->
                <div class="sfp-editor" id="editor" contenteditable="true" role="textbox" aria-multiline="true" data-placeholder="ì—¬ê¸°ì— ê¸€ì„ ì“°ì„¸ìš”."></div>
            </div>

            <!-- ìˆ¨ê¹€ í•„ë“œ -->
            <input type="hidden" name="post_title" id="post_title_hidden">
            <input type="hidden" name="post_content" id="post_content_hidden">
        </form>
    </div>

    <!-- ì„ íƒ íˆ´ë°” (ë˜ëŒë¦¬ê¸°/ë‹¤ì‹œí•˜ê¸°/êµ¬ë¶„ì„ /ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ì—†ìŒ) -->
    <div id="sfp-toolbar" class="sfp-toolbar" style="display:none;">
        <button data-cmd="bold" title="êµµê²Œ" aria-label="êµµê²Œ"><b>B</b></button>
        <button data-cmd="italic" title="ê¸°ìš¸ì„" aria-label="ê¸°ìš¸ì„"><i>I</i></button>
        <button data-cmd="underline" title="ë°‘ì¤„" aria-label="ë°‘ì¤„"><u>U</u></button>
        <span class="sep"></span>
        <button data-cmd="link" title="ë§í¬" aria-label="ë§í¬">ğŸ”—</button>
        <button data-cmd="inlineCode" title="ì¸ë¼ì¸ ì½”ë“œ" aria-label="ì¸ë¼ì¸ ì½”ë“œ">{"</button>
        <span class="sep"></span>
        <button data-cmd="h2" title="ì†Œì œëª©" aria-label="ì†Œì œëª©">H2</button>
        <button data-cmd="quote" title="ì¸ìš©" aria-label="ì¸ìš©">â</button>
        <button data-cmd="ul" title="ë¶ˆë¦¿ ëª©ë¡" aria-label="ë¶ˆë¦¿ ëª©ë¡">â€¢</button>
        <button data-cmd="ol" title="ë²ˆí˜¸ ëª©ë¡" aria-label="ë²ˆí˜¸ ëª©ë¡">1.</button>
        <button data-cmd="codeBlock" title="ì½”ë“œ ë¸”ë¡" aria-label="ì½”ë“œ ë¸”ë¡">{ }</button>
    </div>

    <!-- ë§í¬ ëª¨ë‹¬ -->
    <div class="modal fade" id="sfpLinkModal" tabindex="-1" role="dialog" aria-labelledby="sfpLinkModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="sfpLinkModalLabel">ë§í¬ ì‚½ì…</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="ë‹«ê¸°">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <label for="sfp-link-url">URL (https://â€¦)</label>
            <input type="url" class="form-control" id="sfp-link-url" placeholder="https://example.com" />
            <small class="form-text text-muted">ìƒˆ íƒ­ìœ¼ë¡œ ì—´ë¦¬ë©° nofollowê°€ ì ìš©ë©ë‹ˆë‹¤. ë¹„ìš°ë©´ ë§í¬ê°€ ì œê±°ë©ë‹ˆë‹¤.</small>
          </div>
          <div class="modal-footer">
            <button type="button" id="sfp-remove-link" class="btn btn-danger">ë§í¬ ì œê±°</button>
            <button type="button" id="sfp-insert-link" class="btn btn-primary">ì‚½ì…</button>
          </div>
        </div>
      </div>
    </div>

    <style>
      /* ===== ë¯¸ë””ì—„ ë ˆì´ì•„ì›ƒ/íƒ€ì´í¬ ===== */
      .sfp-medium-shell{--col:720px;--g:24px;--ink:#111;--muted:#6b7280;--ui:#e5e7eb;--brand:#111;--soft:#f5f5f5;}
      .sfp-topbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:12px 20px;background:#fff;border-bottom:1px solid var(--ui);}
      .sfp-topbar-select{border:1px solid var(--ui);border-radius:999px;padding:8px 14px;outline:none;background:#fff;}
      .sfp-btn{border:none;border-radius:999px;padding:9px 16px;font-weight:600;cursor:pointer}
      .sfp-btn.primary{background:var(--brand);color:#fff}
      .sfp-editor-container{max-width:var(--col);margin:48px auto;padding:0 20px}
      .sfp-title{font-size:44px;line-height:1.15;font-weight:800;margin:0 0 8px 0;color:var(--ink)}
      [contenteditable][data-placeholder]:empty:before{content:attr(data-placeholder);color:var(--muted)}
      /* ê°•ì œ í‘œì‹œìš©(ì…ë ¥ í›„ ì „ë¶€ ì§€ì› ì„ ë•Œë„ í‘œì‹œ) */
      [contenteditable][data-placeholder].is-empty:before{content:attr(data-placeholder);color:var(--muted)}
      .sfp-editor{font-size:20px;line-height:1.9;color:var(--ink);min-height:280px}
      .sfp-editor p{margin:0 0 1em 0}
      .sfp-editor h2{font-size:28px;line-height:1.35;font-weight:800;margin:1.2em 0 .6em}
      .sfp-editor blockquote{border-left:3px solid #ddd;color:#555;margin:1.2em 0;padding:.2em 1em;background:transparent}
      .sfp-editor ul,.sfp-editor ol{margin:0 0 1em 1.4em}
      .sfp-editor pre{background:var(--soft);padding:14px;border-radius:8px;overflow:auto;font-size:.95em;line-height:1.6}
      .sfp-editor code{background:var(--soft);padding:2px 6px;border-radius:4px}
      figure.sfp-image{margin:20px 0;text-align:center}
      figure.sfp-image img{max-width:100%;height:auto;border-radius:6px}
      figure.sfp-image figcaption{color:#666;font-size:.9em;margin-top:6px}
      /* ì„ íƒ íˆ´ë°” */
      .sfp-toolbar{position:fixed;z-index:9999;background:#202428;color:#fff;border-radius:10px;padding:6px;box-shadow:0 8px 24px rgba(0,0,0,.18)}
      .sfp-toolbar button{min-width:34px;min-height:34px;border:none;background:transparent;color:#fff;border-radius:8px;margin:0 2px}
      .sfp-toolbar button:hover,.sfp-toolbar button.active{background:#111}
      .sfp-toolbar .sep{display:inline-block;width:1px;height:24px;background:#333;margin:0 6px;vertical-align:middle}
      @media (max-width: 768px){
        .sfp-title{font-size:34px}
        .sfp-editor{font-size:18px}
      }
    </style>

    <script>
    jQuery(function($){
        const $title   = $('#sfp-title');
        const $editor  = $('#editor');
        const $toolbar = $('#sfp-toolbar');
        const isEdit   = <?php echo $is_edit ? 'true' : 'false'; ?>;

        // ì„œë²„ ì´ˆê¸°ê°’ ì±„ìš°ê¸°
        <?php if ($is_edit): ?>
            $title.html(<?php echo json_encode($initial_title); ?>);
            $editor.html(<?php echo json_encode($initial_content); ?>);
        <?php else: ?>
            $title.text('');
            $editor.text('');
        <?php endif; ?>

        // ===== placeholder ë³µêµ¬ ë¡œì§(ì œëª©/ë³¸ë¬¸ ê³µí†µ) =====
        function isContentReallyEmpty($el){
            // í…ìŠ¤íŠ¸ì—ì„œ ê³µë°±/ê°œí–‰/ZWSP/nbsp ì œê±° í›„ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
            const t = $el.text().replace(/\u200B|\u00A0|\s/g,'');
            if(t !== '') return false;
            // ë‚´ìš©ì´ <br>ë§Œ ìˆê±°ë‚˜ ì˜ë¯¸ì—†ëŠ” ë¹ˆ ë…¸ë“œë§Œ ìˆëŠ” ê²½ìš°ë„ ë¹„ì–´ìˆë‹¤ê³  ê°„ì£¼
            const html = $el.html().trim().replace(/<br\s*\/?>/gi,'').replace(/&nbsp;/gi,'').replace(/\u200B/g,'').replace(/\s+/g,'');
            return html === '' || html === '<p></p>' || html === '<p></p><p></p>';
        }
        function refreshPlaceholders(){
            $title.toggleClass('is-empty', isContentReallyEmpty($title));
            $editor.toggleClass('is-empty', isContentReallyEmpty($editor));
        }
        // ì…ë ¥/ì§€ì›€/ë¶™ì—¬ë„£ê¸° ë“± ëª¨ë“  ë³€í™”ì— ë°˜ì‘
        $title.on('input blur keyup paste', refreshPlaceholders);
        $editor.on('input blur keyup paste', refreshPlaceholders);
        // ì´ˆê¸° 1íšŒ ì‹¤í–‰
        refreshPlaceholders();

        // í˜ì´ì§€ ì´íƒˆ ê²½ê³ (ì›ì¹˜ ì•Šìœ¼ë©´ ì´ ë¸”ë¡ ì œê±°)
        let dirty=false, submitting=false;
        const markDirty=()=>{ dirty=true; };
        $title.add($editor).on('input paste', markDirty);
        window.addEventListener('beforeunload', (e)=>{
            if(dirty && !submitting){ e.preventDefault(); e.returnValue=''; }
        });

        // ===== ì„ íƒ íˆ´ë°” =====
        const isSelectionInside = el => {
            const sel = window.getSelection();
            if(!sel || sel.rangeCount===0) return false;
            return el.get(0).contains(sel.getRangeAt(0).commonAncestorContainer);
        };
        function showToolbar(){
            const sel = window.getSelection();
            if(!sel || sel.rangeCount===0) return $toolbar.hide();
            if(sel.isCollapsed || !isSelectionInside($editor)) return $toolbar.hide();
            const range = sel.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const tbW = $toolbar.outerWidth();
            const tbH = $toolbar.outerHeight();
            let top = rect.bottom + 8;
            let left = rect.left + (rect.width/2) - (tbW/2);
            const vwW = window.innerWidth, vwH=window.innerHeight;
            if(top+tbH>vwH-8) top = rect.top - tbH - 8;
            left = Math.max(8, Math.min(left, vwW - tbW - 8));
            $toolbar.css({top: top+'px', left: left+'px'}).show();
            updateToolbarState();
        }
        function updateToolbarState(){
            const btn = (cmd, on)=> $toolbar.find(`[data-cmd="${cmd}"]`).toggleClass('active', !!on).attr('aria-pressed', !!on);
            const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return;
            const node = sel.getRangeAt(0).startContainer;
            const $n = $(node.nodeType===3?node.parentNode:node);
            btn('bold', $n.closest('b,strong').length>0);
            btn('italic', $n.closest('i,em').length>0);
            btn('underline', $n.closest('u').length>0);
            btn('inlineCode', $n.closest('code').length>0 && !$n.closest('pre').length);
            btn('h2', $n.closest('h2').length>0);
            btn('quote', $n.closest('blockquote').length>0);
            btn('ul', $n.closest('ul').length>0);
            btn('ol', $n.closest('ol').length>0);
            btn('codeBlock', $n.closest('pre').length>0);
        }
        document.addEventListener('selectionchange', ()=> { setTimeout(()=> showToolbar(), 100); });
        $(window).on('scroll resize', ()=> $toolbar.hide());
        $(document).on('mousedown touchstart', (e)=>{
            if(!$toolbar.get(0).contains(e.target) && !$editor.get(0).contains(e.target)) $toolbar.hide();
        });

        function wrapInline(tag){
            const sel = window.getSelection();
            if(!sel || sel.rangeCount===0) return;
            const range = sel.getRangeAt(0);
            if(range.collapsed){ document.execCommand('insertText', false, tag==='code'?'code':'í…ìŠ¤íŠ¸'); }
            else { document.execCommand('insertHTML', false, `<${tag}>${range.toString()}</${tag}>`); }
        }
        function unwrapClosest(tag){
            const sel = window.getSelection();
            if(!sel || sel.rangeCount===0) return;
            let el = $(sel.getRangeAt(0).startContainer).closest(tag)[0];
            if(!el) return;
            while(el.firstChild) el.parentNode.insertBefore(el.firstChild, el);
            el.remove();
        }
        function toggleBlock(tag){
            const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return;
            let el = $(sel.getRangeAt(0).startContainer).closest(tag)[0];
            if(el){ // í•´ì œ
                const p = document.createElement('p');
                p.innerHTML = el.innerHTML;
                el.parentNode.replaceChild(p, el);
            } else {
                document.execCommand('formatBlock', false, tag);
            }
        }
        function toggleCodeBlock(){
            const sel = window.getSelection(); if(!sel || sel.rangeCount===0) return;
            let pre = $(sel.getRangeAt(0).startContainer).closest('pre')[0];
            if(pre){
                const p = document.createElement('p'); p.textContent = pre.textContent;
                pre.parentNode.replaceChild(p, pre);
            } else {
                document.execCommand('insertHTML', false, '<pre><code>// ì½”ë“œ ì…ë ¥</code></pre>');
            }
        }
        $toolbar.on('click', 'button', function(e){
            e.preventDefault();
            const cmd = this.getAttribute('data-cmd');
            if(cmd==='bold' || cmd==='italic' || cmd==='underline'){ document.execCommand(cmd,false,null); }
            else if(cmd==='link'){ openLinkModal(); }
            else if(cmd==='inlineCode'){
                const inCode = $(window.getSelection().anchorNode).closest('code').length>0 && !$(window.getSelection().anchorNode).closest('pre').length;
                if(inCode) unwrapClosest('code'); else wrapInline('code');
            }
            else if(cmd==='h2'){ toggleBlock('h2'); }
            else if(cmd==='quote'){ toggleBlock('blockquote'); }
            else if(cmd==='ul'){ document.execCommand('insertUnorderedList'); }
            else if(cmd==='ol'){ document.execCommand('insertOrderedList'); }
            else if(cmd==='codeBlock'){ toggleCodeBlock(); }
            updateToolbarState();
            dirty = true;
            refreshPlaceholders(); // í¬ë§·íŒ…ìœ¼ë¡œ ë¹„ê²Œ ë  ê²½ìš° ëŒ€ë¹„
        });

        // ----- ë§í¬ ëª¨ë‹¬ -----
        let savedRange=null;
        function saveSelection(){
            const sel = window.getSelection(); if(sel && sel.rangeCount>0){ savedRange = sel.getRangeAt(0).cloneRange(); }
        }
        function restoreSelection(){
            if(!savedRange) return false;
            const sel = window.getSelection();
            sel.removeAllRanges(); sel.addRange(savedRange);
            return true;
        }
        function openLinkModal(){
            saveSelection();
            const linkEl = $(window.getSelection().anchorNode).closest('a')[0];
            $('#sfp-link-url').val(linkEl ? (linkEl.getAttribute('href')||'') : 'https://');
            $('#sfpLinkModal').modal('show');
            setTimeout(()=> $('#sfp-link-url').trigger('focus'), 200);
        }
        $('#sfp-insert-link').on('click', function(){
            $('#sfpLinkModal').modal('hide');
            setTimeout(()=>{
                if(!restoreSelection()) return;
                const url = ($('#sfp-link-url').val()||'').trim();
                if(url && !/^https?:\/\//i.test(url)){ alert('https:// ë¥¼ í¬í•¨í•œ ì˜¬ë°”ë¥¸ URLì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
                const existing = $(window.getSelection().anchorNode).closest('a')[0];
                if(existing){
                    if(url){ existing.href=url; existing.target='_blank'; existing.rel='nofollow noopener'; }
                    else {
                        const parent = existing.parentNode; while(existing.firstChild){ parent.insertBefore(existing.firstChild, existing); } parent.removeChild(existing);
                    }
                }else if(url){
                    document.execCommand('createLink', false, url);
                    const a = $(window.getSelection().anchorNode).closest('a')[0];
                    if(a){ a.target='_blank'; a.rel='nofollow noopener'; }
                }
                dirty = true;
            },150);
        });
        $('#sfp-remove-link').on('click', function(){
            $('#sfpLinkModal').modal('hide');
            setTimeout(()=>{
                if(!restoreSelection()) return;
                document.execCommand('unlink', false, null);
                dirty = true;
            },150);
        });

        // ----- ì´ë¯¸ì§€ ì—…ë¡œë“œ(ë²„íŠ¼/ë“œë¡­/ë¶™ì—¬ë„£ê¸°) + ìº¡ì…˜ -----
        let $file = $('#post_image');
        if(!$file.length){
            $file = $('<input type="file" id="post_image" class="d-none" accept="image/*" multiple>');
            document.body.appendChild($file.get(0));
        }
        $file.on('change', function(){ if(this.files.length) uploadImages(this.files); });

        function makeImageFigure(url){
            const fig = document.createElement('figure'); fig.className='sfp-image';
            const img = document.createElement('img'); img.src=url;
            const cap = document.createElement('figcaption'); cap.contentEditable='true'; cap.setAttribute('data-placeholder','ìº¡ì…˜ ì¶”ê°€(ì„ íƒ)');
            fig.appendChild(img); fig.appendChild(cap);
            return fig;
        }
        // ë“œë˜ê·¸ì•¤ë“œë¡­
        $editor.on('dragover', function(e){ e.preventDefault(); e.originalEvent.dataTransfer.dropEffect='copy'; });
        $editor.on('drop', function(e){
            e.preventDefault();
            const files = e.originalEvent.dataTransfer.files;
            if(files && files.length) uploadImages(files);
        });
        // ë¶™ì—¬ë„£ê¸°(ì´ë¯¸ì§€)
        $editor.on('paste', function(e){
            const items = (e.originalEvent.clipboardData || {}).items || [];
            for(const it of items){
                if(it.type && it.type.indexOf('image')===0){
                    const file = it.getAsFile(); if(file){ uploadImages([file]); }
                }
            }
        });
        function uploadImages(fileList){
            const formData = new FormData();
            formData.append('action', 'sfp_upload_image');
            formData.append('nonce', '<?php echo wp_create_nonce("sfp_upload_nonce"); ?>');
            for(let i=0;i<fileList.length;i++){ formData.append('images[]', fileList[i]); }

            const loader = document.createElement('p'); loader.textContent='ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘â€¦';
            const sel = window.getSelection();
            if(sel && sel.rangeCount>0) sel.getRangeAt(0).insertNode(loader);
            else $editor.get(0).appendChild(loader);

            $.ajax({
                url: '<?php echo admin_url("admin-ajax.php"); ?>',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false
            }).done(function(res){
                loader.remove();
                if(res && res.success && Array.isArray(res.data)){
                    insertImages(res.data);
                } else {
                    alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + (res && res.data ? res.data : 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            }).fail(function(){
                loader.remove();
                alert('ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
        function insertImages(urls){
            const sel = window.getSelection();
            urls.forEach(url=>{
                const fig = makeImageFigure(url);
                if(sel && sel.rangeCount>0 && $editor.get(0).contains(sel.anchorNode)){
                    const range = sel.getRangeAt(0);
                    range.collapse(false);
                    range.insertNode(fig);
                    range.setStartAfter(fig); range.collapse(true);
                    sel.removeAllRanges(); sel.addRange(range);
                } else {
                    $editor.get(0).appendChild(fig);
                }
            });
            dirty = true;
            refreshPlaceholders(); // ë³¸ë¬¸ì´ ë¹„ì–´ìˆë‹¤ê°€ ì´ë¯¸ì§€ ì¶”ê°€/ì‚­ì œ ì‹œ ìƒíƒœ ë°˜ì˜
        }

        // ----- ì œì¶œ ì „ ì •ë¦¬ & ê°’ ì„¸íŒ… -----
        function cleanHTML(root){
            const wrap = document.createElement('div'); wrap.innerHTML = root.innerHTML;
            // ë¶ˆí•„ìš” BR/ë¹ˆ ë¸”ë¡ ì œê±°
            wrap.querySelectorAll('p,h2,blockquote,li').forEach(el=>{
                while(el.firstChild && el.firstChild.tagName==='BR') el.removeChild(el.firstChild);
                while(el.lastChild && el.lastChild.tagName==='BR') el.removeChild(el.lastChild);
                const txt = (el.textContent||'').replace(/\u200B|\s|\n/g,'');
                if(!txt && !el.querySelector('img') && el.tagName!=='LI'){ el.remove(); }
            });
            return wrap.innerHTML.trim();
        }

        $('#frontend-post-form').on('submit', function(){
            submitting=true;
            const title = $title.text().trim();
            if(!title){
                alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                submitting=false;
                return false;
            }
            const contentHTML = cleanHTML($editor.get(0));
            $('#post_title_hidden').val(title);
            $('#post_content_hidden').val(contentHTML);
            return true; // ë°”ë¡œ ë°œí–‰/ì—…ë°ì´íŠ¸
        });

        // placeholder ì´ˆê¸°í™” ì¬í™•ì¸(ì´ë¯¸ì§€/í¬ë§· ì‚½ì… ë“± í›„)
        refreshPlaceholders();
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('sfp_frontend_post_form', 'sfp_frontend_post_form');

// AJAX ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
function sfp_handle_ajax_image_upload() {
    if (!isset($_POST['nonce']) || !wp_verify_nonce($_POST['nonce'], 'sfp_upload_nonce')) { wp_die('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); }
    if (!is_user_logged_in()) { wp_send_json_error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.'); }
    if (empty($_FILES['images'])) { wp_send_json_error('ì—…ë¡œë“œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.'); }

    require_once(ABSPATH . 'wp-admin/includes/image.php');
    require_once(ABSPATH . 'wp-admin/includes/file.php');
    require_once(ABSPATH . 'wp-admin/includes/media.php');

    $uploaded_images = [];
    $files = $_FILES['images'];

    for ($i = 0; $i < count($files['name']); $i++) {
        if ($files['error'][$i] === UPLOAD_ERR_OK) {
            $file = [
                'name'     => $files['name'][$i],
                'type'     => $files['type'][$i],
                'tmp_name' => $files['tmp_name'][$i],
                'error'    => $files['error'][$i],
                'size'     => $files['size'][$i]
            ];
            $movefile = wp_handle_upload($file, ['test_form' => false]);
            if ($movefile && !isset($movefile['error'])) {
                $attachment = [
                    'post_mime_type' => $movefile['type'],
                    'post_title'     => sanitize_file_name($file['name']),
                    'post_content'   => '',
                    'post_status'    => 'inherit'
                ];
                $attach_id  = wp_insert_attachment($attachment, $movefile['file']);
                $attach_data = wp_generate_attachment_metadata($attach_id, $movefile['file']);
                wp_update_attachment_metadata($attach_id, $attach_data);
                $uploaded_images[] = wp_get_attachment_url($attach_id);
            }
        }
    }

    if (!empty($uploaded_images)) wp_send_json_success($uploaded_images);
    else wp_send_json_error('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
}
add_action('wp_ajax_sfp_upload_image', 'sfp_handle_ajax_image_upload');
add_action('wp_ajax_nopriv_sfp_upload_image', 'sfp_handle_ajax_image_upload');

// ê¸€ ì œì¶œ/ìˆ˜ì • ì²˜ë¦¬ (ë°”ë¡œ ë°œí–‰/ì—…ë°ì´íŠ¸)
function sfp_handle_post_submission() {
    if (isset($_POST['submit_post']) && is_user_logged_in()) {
        if (!isset($_POST['sfp_nonce']) || !wp_verify_nonce($_POST['sfp_nonce'], 'sfp_frontend_post_nonce')) {
            wp_die('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
        }

        $post_title    = sanitize_text_field($_POST['post_title'] ?? '');
        $post_content  = wp_kses_post($_POST['post_content'] ?? '');
        $post_category = intval($_POST['post_category'] ?? 0);
        if (empty($post_category)) wp_die('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤.');

        $edit_post_id = isset($_POST['edit_post_id']) ? absint($_POST['edit_post_id']) : 0;

        if ($edit_post_id) {
            if (!current_user_can('edit_post', $edit_post_id)) wp_die('ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            $postarr = [
                'ID'           => $edit_post_id,
                'post_title'   => $post_title,
                'post_content' => $post_content,
                'post_category'=> [$post_category],
            ];
            $pid = wp_update_post($postarr, true);
            if (!is_wp_error($pid)) {
                set_transient('sfp_flash_' . get_current_user_id(), [
                    'post_id' => $pid,
                    'message' => 'ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!',
                ], 60);
                wp_redirect(get_permalink($pid));
                exit;
            } else {
                wp_die('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' . $pid->get_error_message());
            }
        } else {
            $post_id = wp_insert_post([
                'post_title'   => $post_title,
                'post_content' => $post_content,
                'post_status'  => 'publish', // í•„ìš” ì‹œ 'pending'ìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥
                'post_author'  => get_current_user_id(),
                'post_category'=> [$post_category],
                'post_type'    => 'post',
            ]);
            if ($post_id) {
                set_transient('sfp_flash_' . get_current_user_id(), [
                    'post_id' => $post_id,
                    'message' => 'ê¸€ì´ ì„±ê³µì ìœ¼ë¡œ ë°œí–‰ë˜ì—ˆìŠµë‹ˆë‹¤!',
                ], 60);
                wp_redirect(get_permalink($post_id));
                exit;
            } else {
                wp_die('ê¸€ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
    }
}
add_action('init', 'sfp_handle_post_submission');

// ì„±ê³µ ë©”ì‹œì§€ 1íšŒì„± í‘œì‹œ
function enqueue_submission_message() {
    if (!is_user_logged_in()) return;
    $user_id = get_current_user_id();
    $flash = get_transient('sfp_flash_' . $user_id);
    if (!$flash || empty($flash['post_id'])) return;

    $current_id = get_queried_object_id();
    if ((int)$current_id !== (int)$flash['post_id']) return;

    delete_transient('sfp_flash_' . $user_id);
    $msg = !empty($flash['message']) ? $flash['message'] : 'ì‘ì—…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';

    add_action('wp_footer', function() use ($msg) {
        echo '<div id="sfp-success-message" style="position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#28a745;color:#fff;padding:15px;border-radius:5px;z-index:9999;transition:opacity .4s;">'.esc_html($msg).'</div>';
        echo '<script>
            (function(){
                var el = document.getElementById("sfp-success-message");
                if(!el) return;
                setTimeout(function(){
                    el.style.opacity = "0";
                    setTimeout(function(){ if(el && el.parentNode){ el.parentNode.removeChild(el); } }, 500);
                }, 4000);
            })();
        </script>';
    });
}
add_action('wp', 'enqueue_submission_message');
