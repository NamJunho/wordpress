/**
 * Plugin Name: CC Lite Comments Split (WYSIWYG)
 * Description: 댓글 폼과 목록을 분리한 WYSIWYG 댓글(콘텐트에디터블 + execCommand, AJAX 저장). [cc_comment_form] / [cc_comment_list]
 */
if (!defined('ABSPATH')) exit;

/* ---------------------------------
 *  공통: 허용 태그(보안)
 * --------------------------------- */
function cc_allowed_tags_wysiwyg() {
    return [
        'p'=>[], 'br'=>[],
        'strong'=>[], 'b'=>[],
        'em'=>[], 'i'=>[],
        'u'=>[],
        'blockquote'=>[],
        'ul'=>[], 'ol'=>[], 'li'=>[],
        'code'=>[], 'pre'=>[],
        'a'=>['href'=>[], 'title'=>[], 'rel'=>[], 'target'=>[]],
        'h2'=>[], // 필요 없으면 제거 가능
    ];
}

/* ---------------------------------
 *  공통: 댓글 LI 렌더 (아바타 추가)
 * --------------------------------- */
function cc_render_comment_li_html($c){
    $author = get_comment_author($c);
    $date   = esc_html(get_date_from_gmt($c->comment_date_gmt, 'Y-m-d H:i'));
    $html   = wp_kses($c->comment_content, cc_allowed_tags_wysiwyg());
    
    // 아바타 가져오기
    $avatar_html = '';
    if ($c->user_id) {
        $custom_avatar = get_user_meta($c->user_id, 'custom_avatar', true);
        if ($custom_avatar) {
            // custom_avatar가 있으면 사용
            $avatar_html = '<img src="' . esc_url($custom_avatar) . '" alt="' . esc_attr($author) . '" class="cc-avatar" />';
        } else {
            // custom_avatar가 없으면 워드프레스 기본 아바타 사용
            $avatar_html = get_avatar($c->user_id, 32, '', $author, ['class' => 'cc-avatar']);
        }
    } else {
        // 비회원의 경우 이메일로 아바타 가져오기 (Gravatar 또는 기본 아바타)
        $avatar_html = get_avatar($c->comment_author_email, 32, '', $author, ['class' => 'cc-avatar']);
    }
    
    return '<li class="cc-item">
        <div class="cc-card">
            <div class="cc-meta">
                <div class="cc-author-info">
                    ' . $avatar_html . '
                    <strong class="cc-author">'.esc_html($author).'</strong>
                </div>
                <span class="cc-dot">•</span><span class="cc-date">'.$date.'</span>
            </div>
            <div class="cc-content">'.$html.'</div>
        </div>
    </li>';
}

/* ---------------------------------
 *  공통: 에셋(스타일/토스트) 1회 출력
 * --------------------------------- */
function cc_comments_print_assets_once(){
    static $printed = false;
    if ($printed) return;
    $printed = true;
    ?>
    <style>
    .cc-wrap{margin:24px 0;font-family:system-ui}
    .cc-title{margin:0 0 12px;font-size:18px;font-weight:600}

    /* 카드형 댓글 */
    .cc-list{list-style:none;padding:0;margin:0 0 16px}
    .cc-item{margin:12px 0}
    .cc-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:14px 16px;box-shadow:0 1px 2px rgba(0,0,0,.03)}
    .cc-meta{font-size:13px;color:#5f6368;display:flex;gap:6px;align-items:center;margin-bottom:6px}
    .cc-dot{opacity:.6}
    
    /* 아바타 스타일 */
    .cc-author-info{display:flex;align-items:center;gap:8px}
    .cc-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;flex-shrink:0}
    
    .cc-content p{margin:6px 0}
    .cc-content pre{background:#f6f8fa;padding:10px;border-radius:8px;overflow:auto;font-size:.95em;line-height:1.6}
    .cc-content code{background:#f6f6f6;padding:2px 6px;border-radius:4px}
    .cc-content blockquote{margin:6px 0;padding:6px 10px;border-left:3px solid #ddd;background:#fafafa}
    .cc-content ul,.cc-content ol{margin:6px 0 6px 20px}

    /* 에디터 박스 */
    .cc-editor{border:1px solid #e1e1e1;border-radius:12px;background:#fff}
    .cc-body{padding:12px}
    /* collapsed: 입력영역만 보이고, 툴바/버튼 숨김 */
    .cc-editor.collapsed .cc-toolbar,
    .cc-editor.collapsed .cc-actions{display:none !important;}
    .cc-editor.expanded .cc-toolbar,
    .cc-editor.expanded .cc-actions{display:flex;}

    /* 고정형 툴바 */
    .cc-toolbar{border-bottom:1px solid #eee;padding:8px;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .cc-toolbar button{border:1px solid #ddd;background:#fff;padding:6px 10px;border-radius:6px;cursor:pointer}
    .cc-toolbar button:hover{background:#f5f5f5}

    /* contenteditable 입력영역 */
    .cc-input[contenteditable="true"]{min-height:80px;outline:none;white-space:pre-wrap;word-break:break-word}
    .cc-input{font-size:15px;line-height:1.6;color:#111;padding:0;border:0}
    .cc-input:empty:before{content: attr(data-placeholder); color:#9aa0a6;}

    /* 액션 버튼 */
    .cc-actions{padding:8px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid #eee}
    .cc-btn{border:1px solid #ddd;background:#fff;color:#111;padding:8px 14px;border-radius:8px;cursor:pointer}
    .cc-btn:hover{background:#f5f5f5}
    .cc-btn.primary{border:0;background:#1a73e8;color:#fff}

    /* Toast (페이지 전역 하나) */
    .cc-toast{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:#1f2937;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.2);font-size:14px;opacity:0;pointer-events:none;transition:opacity .2s ease; z-index:9999}
    .cc-toast.show{opacity:1}
    </style>
    <div id="ccToast" class="cc-toast" role="status" aria-live="polite" aria-atomic="true"></div>
    <?php
}

/* ---------------------------------
 *  AJAX: 댓글 저장 (WYSIWYG HTML 그대로)
 * --------------------------------- */
add_action('wp_ajax_cc_add_comment', function(){
    if (!is_user_logged_in()) wp_send_json_error(['message'=>'로그인이 필요합니다.'], 403);
    check_ajax_referer('cc_nonce', 'nonce');

    $post_id = intval($_POST['post_id'] ?? 0);
    if (!$post_id || !get_post_status($post_id)) wp_send_json_error(['message'=>'유효하지 않은 글'], 400);

    $raw_html = (string)($_POST['html'] ?? '');
    if (trim(wp_strip_all_tags($raw_html)) === '') {
        wp_send_json_error(['message'=>'내용을 입력하세요'], 422);
    }
    $safe_html = wp_kses($raw_html, cc_allowed_tags_wysiwyg());

    $u = wp_get_current_user();
    $cid = wp_insert_comment([
        'comment_post_ID'      => $post_id,
        'comment_author'       => $u->display_name ?: $u->user_login,
        'comment_author_email' => $u->user_email,
        'comment_content'      => $safe_html,
        'user_id'              => $u->ID,
        'comment_approved'     => 1,
        'comment_date'         => current_time('mysql'),
        'comment_date_gmt'     => current_time('mysql',1),
    ]);
    if(!$cid) wp_send_json_error(['message'=>'저장 실패'], 500);

    wp_send_json_success(['html'=>cc_render_comment_li_html(get_comment($cid))]);
});

/* ---------------------------------
 *  쇼트코드 1: 댓글 목록 [cc_comment_list post_id="" number="50" order="DESC"]
 * --------------------------------- */
function cc_comment_list_sc($atts){
    cc_comments_print_assets_once();

    $a = shortcode_atts([
        'post_id' => 0,
        'number'  => 50,
        'order'   => 'DESC',
        'title'   => '댓글',
        'list_id' => '', // 자동 생성: ccList-{postID}
    ], $atts, 'cc_comment_list');

    global $post;
    $post_id = intval($a['post_id'] ?: ($post->ID ?? 0));
    if (!$post_id) return '<div class="cc-wrap">유효한 글을 찾을 수 없습니다.</div>';

    $list_id = $a['list_id'] ?: ('ccList-' . $post_id);

    $comments = get_comments([
        'post_id' => $post_id,
        'status'  => 'approve',
        'number'  => intval($a['number']),
        'order'   => strtoupper($a['order'])==='ASC' ? 'ASC' : 'DESC',
        'orderby' => 'comment_date_gmt',
    ]);
    $items = '';
    foreach($comments as $c) $items .= cc_render_comment_li_html($c);

    ob_start(); ?>
    <div class="cc-wrap">
      <h3 class="cc-title"><?php echo esc_html($a['title']); ?></h3>
      <ol class="cc-list" id="<?php echo esc_attr($list_id); ?>">
        <?php echo $items ?: '<li class="cc-item"><div class="cc-card"><div class="cc-content">아직 댓글이 없습니다.</div></div></li>'; ?>
      </ol>
    </div>
    <?php
    return ob_get_clean();
}
add_shortcode('cc_comment_list', 'cc_comment_list_sc');

/* ---------------------------------
 *  쇼트코드 2: 댓글 작성 폼 [cc_comment_form post_id="" list_id=""]
 *  - list_id: 같은 페이지의 목록 ID를 지정하면, 저장 성공 시 해당 목록 맨 앞에 추가
 * --------------------------------- */
function cc_comment_form_sc($atts){
    cc_comments_print_assets_once();
    wp_enqueue_script('jquery');

    $a = shortcode_atts([
        'post_id' => 0,
        'list_id' => '', // 기본 ccList-{postID}
    ], $atts, 'cc_comment_form');

    global $post;
    $post_id = intval($a['post_id'] ?: ($post->ID ?? 0));
    if (!$post_id) return '<div class="cc-wrap">유효한 글을 찾을 수 없습니다.</div>';

    $list_id = $a['list_id'] ?: ('ccList-' . $post_id);

    $nonce  = wp_create_nonce('cc_nonce');
    $ajax   = admin_url('admin-ajax.php');
    $uid    = 'ccf_' . substr(md5(uniqid('', true)), 0, 8); // 인스턴스 구분용

    ob_start(); ?>
    <div class="cc-wrap">
      <div id="ccEditor-<?php echo esc_attr($uid); ?>" class="cc-editor collapsed"
           data-ajax="<?php echo esc_attr($ajax); ?>"
           data-nonce="<?php echo esc_attr($nonce); ?>"
           data-postid="<?php echo esc_attr($post_id); ?>"
           data-listid="<?php echo esc_attr($list_id); ?>">

        <?php if(!is_user_logged_in()): ?>
          <div class="cc-body" style="text-align:center; padding:16px;">
            댓글은 <a href="<?php echo esc_url(wp_login_url(get_permalink($post_id)));?>">로그인</a> 후 작성할 수 있습니다.
          </div>
        <?php else: ?>
          <!-- 고정형 툴바(플로팅 X). 아이콘은 글쓰기에서 쓰신 SVG로 교체하셔도 됩니다. -->
          <div class="cc-toolbar" id="ccToolbar-<?php echo esc_attr($uid); ?>" aria-label="formatting">
            <button type="button" data-cmd="bold" title="굵게"><b>B</b></button>
            <button type="button" data-cmd="italic" title="기울임"><i>I</i></button>
            <button type="button" data-cmd="underline" title="밑줄"><u>U</u></button>
            <span style="width:1px;height:24px;background:#e5e5e5"></span>
            <button type="button" data-cmd="quote" title="인용">""</button>
            <button type="button" data-cmd="ul" title="불릿 목록">• List</button>
            <button type="button" data-cmd="ol" title="번호 목록">1. List</button>
            <span style="width:1px;height:24px;background:#e5e5e5"></span>
            <button type="button" data-cmd="inlineCode" title="인라인 코드">&lt;/&gt;</button>
            <button type="button" data-cmd="codeBlock" title="코드 블록">```</button>
            <button type="button" data-cmd="link" title="링크">🔗</button>
          </div>

          <div class="cc-body">
            <div id="ccContent-<?php echo esc_attr($uid); ?>" class="cc-input" contenteditable="true"
                 role="textbox" aria-multiline="true" data-placeholder="댓글을 남겨주세요..."></div>
          </div>

          <div class="cc-actions">
            <button id="ccCancel-<?php echo esc_attr($uid); ?>" type="button" class="cc-btn">취소</button>
            <button id="ccSubmit-<?php echo esc_attr($uid); ?>" type="button" class="cc-btn primary">게시</button>
          </div>
        <?php endif; ?>
      </div>
    </div>

    <script>
    jQuery(function($){
      var $root    = $("#ccEditor-<?php echo esc_js($uid); ?>");
      var $content = $("#ccContent-<?php echo esc_js($uid); ?>");
      var $toolbar = $("#ccToolbar-<?php echo esc_js($uid); ?>");
      var $submit  = $("#ccSubmit-<?php echo esc_js($uid); ?>");
      var $cancel  = $("#ccCancel-<?php echo esc_js($uid); ?>");

      if(!$content.length) return; // 비로그인 등

      // 초기: collapsed (입력영역만 보임)
      $root.addClass('collapsed');

      function expand(){ $root.removeClass('collapsed').addClass('expanded'); }
      function collapse(){ $root.removeClass('expanded').addClass('collapsed'); $content.empty(); }

      // 클릭/포커스 시 확장
      $content.on('focus', expand);

      // 취소 → 접기
      $cancel.on('click', collapse);

      // 툴바 동작 (execCommand)
      $toolbar.on('click','button',function(e){
        e.preventDefault();
        var cmd = $(this).data('cmd');
        $content.focus();

        if(cmd === 'bold' || cmd === 'italic' || cmd === 'underline'){
          document.execCommand(cmd, false, null);
        } else if(cmd === 'ul'){
          document.execCommand('insertUnorderedList', false, null);
        } else if(cmd === 'ol'){
          document.execCommand('insertOrderedList', false, null);
        } else if(cmd === 'quote'){
          toggleBlock('blockquote');
        } else if(cmd === 'codeBlock'){
          toggleCodeBlock();
        } else if(cmd === 'inlineCode'){
          toggleInlineCode();
        } else if(cmd === 'link'){
          var url = prompt('링크 URL을 입력하세요 (https://…):', 'https://');
          if(url === null) return;
          if(url.trim() === ''){
            document.execCommand('unlink');
          } else {
            if(!/^https?:\/\//i.test(url)) { alert('https:// 를 포함해 주세요.'); return; }
            document.execCommand('createLink', false, url);
            var a = $(window.getSelection().anchorNode).closest('a')[0];
            if(a){ a.target = '_blank'; a.rel = 'nofollow noopener'; }
          }
        }
      });

      function toggleBlock(tag){
        var sel = window.getSelection(); if(!sel || sel.rangeCount === 0) return;
        var range = sel.getRangeAt(0);
        var $closest = $(range.startContainer).closest(tag);
        if($closest.length){
          var el = $closest.get(0);
          var p = document.createElement('p');
          p.innerHTML = el.innerHTML;
          el.parentNode.replaceChild(p, el);
        }else{
          document.execCommand('formatBlock', false, tag);
        }
      }

      function toggleCodeBlock(){
        var sel = window.getSelection(); if(!sel || sel.rangeCount === 0) return;
        var range = sel.getRangeAt(0);
        var $pre = $(range.startContainer).closest('pre');
        if($pre.length){
          var el = $pre.get(0);
          var p = document.createElement('p');
          p.textContent = el.textContent;
          el.parentNode.replaceChild(p, el);
        }else{
          document.execCommand('insertHTML', false, '<pre><code>// 코드 입력</code></pre>');
        }
      }

      function toggleInlineCode(){
        var sel = window.getSelection(); if(!sel || sel.rangeCount === 0) return;
        var range = sel.getRangeAt(0);
        if(range.collapsed){
          document.execCommand('insertHTML', false, '<code>code</code>');
          return;
        }
        var $in = $(range.startContainer).closest('code');
        if($in.length && !$in.closest('pre').length){
          var el = $in.get(0);
          while(el.firstChild) el.parentNode.insertBefore(el.firstChild, el);
          el.remove();
        }else{
          var text = range.toString().replace(/[&<>\"']/g, function(m){return {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m];});
          document.execCommand('insertHTML', false, '<code>'+text+'</code>');
        }
      }

      // 제출
      $submit.on('click', function(){
        var plain = $content.text().replace(/\u200B|\s|\n/g,'');
        if(!plain){ showToast('내용을 입력하세요'); return; }

        var html = cleanHTML($content.get(0));
        $submit.prop('disabled', true);

        $.post($root.data('ajax'), {
          action: 'cc_add_comment',
          nonce:  $root.data('nonce'),
          post_id:$root.data('postid'),
          html:   html
        }).done(function(r){
          if(r && r.success && r.data && r.data.html){
            // 같은 페이지에 목록이 있으면 prepend
            var listSel = String($root.data('listid')||'').trim();
            if(listSel){
              var $list = $('#'+listSel.replace(/^#/, ''));
              if($list.length){
                var $node = $(r.data.html);
                $list.prepend($node);
              }
            }
            showToast('등록 완료');
            collapse();
          }else{
            showToast(r?.data?.message || '오류가 발생했습니다.');
          }
        }).fail(function(){
          showToast('네트워크 또는 권한 오류입니다.');
        }).always(function(){
          $submit.prop('disabled', false);
        });
      });

      // HTML 정리(필요 최소한)
      function cleanHTML(root){
        var wrap = document.createElement('div');
        wrap.innerHTML = root.innerHTML;

        // 링크 속성 보정
        wrap.querySelectorAll('a[href]').forEach(function(a){
          var href = a.getAttribute('href') || '';
          if(/^https?:\/\//i.test(href)){
            a.setAttribute('target','_blank');
            a.setAttribute('rel','nofollow noopener');
          }
        });

        // 빈 블록 정리
        wrap.querySelectorAll('p,h2,blockquote,li').forEach(function(el){
          while(el.firstChild && el.firstChild.nodeName==='BR') el.removeChild(el.firstChild);
          while(el.lastChild && el.lastChild.nodeName==='BR') el.removeChild(el.lastChild);
          var txt=(el.textContent||'').replace(/\u200B|\s|\n/g,'');
          if(!txt && !el.querySelector('img') && el.tagName!=='LI'){ el.remove(); }
        });

        return wrap.innerHTML.trim();
      }

      // 토스트(전역 하나)
      function showToast(text){
        var el = document.getElementById('ccToast');
        if(!el){
          el = document.createElement('div');
          el.id = 'ccToast';
          el.className = 'cc-toast';
          el.setAttribute('role','status');
          el.setAttribute('aria-live','polite');
          document.body.appendChild(el);
        }
        el.textContent = text;
        el.classList.add('show');
        setTimeout(function(){ el.classList.remove('show'); }, 3000);
      }
    });
    </script>
    <?php
    return ob_get_clean();
}
add_shortcode('cc_comment_form', 'cc_comment_form_sc');
